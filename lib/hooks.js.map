{"version":3,"sources":["../src/hooks.js"],"names":["DEFAULT_NODE","P","defaultPlugins","ParagraphPlugin","EmphasizePlugin","HeadingsPlugin","LinkPlugin","CodePlugin","ListsPlugin","BlockquotePlugin","AlignmentPlugin","lineBreakSerializer","deserialize","el","tagName","toLowerCase","object","text","nodeName","value","match","leaves","serialize","children","type","html","Html","rules","parseHtml","parse5","parseFragment","options","createInitialState","editorState","Value","fromJSON","document","nodes","unserialize","importFromHtml","serialized","toJSON","merge","states","mergedNodes","a","b","concat","mergedDocument","Document","create","mergedEditorState","split","state","map","node","splittedDocument","splittedEditorState","toArray","handleRemoveHotKey","_","content","Promise","resolve","reject","Plain","length","windowSelectionWaitTime","handleFocusPreviousHotKey","e","selection","isExpanded","setTimeout","isAtStartOf","first","handleFocusNextHotKey","isAtEndOf","last"],"mappings":"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","file":"hooks.js","sourcesContent":["/*\r\n * This file is part of ORY Editor.\r\n *\r\n * ORY Editor is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * (at your option) any later version.\r\n *  \r\n * ORY Editor is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *  \r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with ORY Editor.  If not, see <http://www.gnu.org/licenses/>.\r\n *\r\n * @license LGPL-3.0\r\n * @copyright 2016-2018 Aeneas Rekkas\r\n * @author Aeneas Rekkas <aeneas+oss@aeneas.io>\r\n *\r\n */\r\n\r\n// @flow\r\n// FIXME #125: missing types for slate internals\r\n/* eslint-disable new-cap, arrow-body-style, react/display-name */\r\nimport { List } from 'immutable'\r\nimport head from 'ramda/src/head'\r\nimport map from 'ramda/src/map'\r\nimport path from 'ramda/src/path'\r\nimport reduce from 'ramda/src/reduce'\r\nimport tail from 'ramda/src/tail'\r\nimport React from 'react'\r\nimport type { Props } from './Component'\r\nimport AlignmentPlugin from './plugins/alignment'\r\nimport BlockquotePlugin from './plugins/blockquote'\r\nimport CodePlugin from './plugins/code'\r\nimport EmphasizePlugin from './plugins/emphasize'\r\nimport HeadingsPlugin from './plugins/headings'\r\nimport LinkPlugin from './plugins/link'\r\nimport ListsPlugin from './plugins/lists'\r\nimport ParagraphPlugin, { P } from './plugins/paragraph'\r\nimport parse5 from 'parse5'\r\n\r\n// FIXME #126\r\nimport { Document, Value } from 'slate'\r\nimport Html from 'slate-html-serializer'\r\nimport Plain from 'slate-plain-serializer'\r\n\r\nconst DEFAULT_NODE = P\r\n\r\nexport const defaultPlugins = [\r\n  new ParagraphPlugin(),\r\n  new EmphasizePlugin(),\r\n  new HeadingsPlugin({ DEFAULT_NODE }),\r\n  new LinkPlugin(),\r\n  new CodePlugin({ DEFAULT_NODE }),\r\n  new ListsPlugin({ DEFAULT_NODE }),\r\n  new BlockquotePlugin({ DEFAULT_NODE }),\r\n  new AlignmentPlugin()\r\n  // new KatexPlugin({ DEFAULT_NODE })\r\n]\r\n\r\nexport const lineBreakSerializer = {\r\n  deserialize(el: any) {\r\n    if (el.tagName.toLowerCase() === 'br') {\r\n      return { object: 'text', text: '\\n' }\r\n    }\r\n    if (el.nodeName === '#text') {\r\n      if (el.value && el.value.match(/<!--.*?-->/)) return\r\n\r\n      return {\r\n        object: 'text',\r\n        leaves: [\r\n          {\r\n            object: 'leaf',\r\n            text: el.value\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  },\r\n  serialize(object: any, children: any) {\r\n    if (object.type === 'text' || children === '\\n') {\r\n      return <br />\r\n    }\r\n  }\r\n}\r\n\r\nexport const html = new Html({\r\n  rules: [...defaultPlugins, lineBreakSerializer],\r\n  parseHtml: parse5.parseFragment\r\n})\r\n\r\nconst options = {}\r\n\r\nexport const createInitialState = () => ({\r\n  editorState: Value.fromJSON(\r\n    {\r\n      document: {\r\n        nodes: [\r\n          {\r\n            object: 'block',\r\n            type: P,\r\n            nodes: [\r\n              {\r\n                object: 'text',\r\n                leaves: [\r\n                  {\r\n                    text: ''\r\n                  }\r\n                ]\r\n              }\r\n            ]\r\n          }\r\n        ]\r\n      }\r\n    },\r\n    options\r\n  )\r\n})\r\n\r\nexport const unserialize = ({\r\n  importFromHtml,\r\n  serialized,\r\n  editorState\r\n}: {\r\n  importFromHtml: string,\r\n  serialized: Object,\r\n  editorState: Object\r\n}): { editorState: Object } => {\r\n  if (serialized) {\r\n    return { editorState: Value.fromJSON(serialized, options) }\r\n  } else if (importFromHtml) {\r\n    return { editorState: html.deserialize(importFromHtml, options) }\r\n  } else if (editorState) {\r\n    return { editorState }\r\n  }\r\n\r\n  return createInitialState()\r\n}\r\n\r\nexport const serialize = ({ editorState }: any) => ({\r\n  serialized: editorState.toJSON(editorState, options)\r\n})\r\n\r\nexport const merge = (states: Object[]): Object => {\r\n  const nodes = map(path(['editorState', 'document', 'nodes']), states)\r\n  const mergedNodes = reduce(\r\n    (a: List<any>, b: List<any>) => a.concat(b),\r\n    head(nodes),\r\n    tail(nodes)\r\n  )\r\n  const mergedDocument = Document.create({ nodes: mergedNodes })\r\n  const mergedEditorState = Value.create({ document: mergedDocument })\r\n\r\n  return { editorState: mergedEditorState }\r\n}\r\n\r\nexport const split = (state: Object): Object[] => {\r\n  const nodes = path(['editorState', 'document', 'nodes'], state)\r\n\r\n  return nodes\r\n    .map((node: any) => {\r\n      const splittedDocument = Document.create({ nodes: List([node]) })\r\n      const splittedEditorState = Value.create({ document: splittedDocument })\r\n\r\n      return { editorState: splittedEditorState }\r\n    })\r\n    .toArray()\r\n}\r\n\r\n// const position = (): {\r\n//   top: ?number,\r\n//   right: ?number,\r\n//   left: ?number,\r\n//   bottom: ?number\r\n// } => {\r\n//   if (window && window.getSelection) {\r\n//     const selection = window.getSelection()\r\n//     if (!selection.rangeCount) {\r\n//       return {\r\n//         top: null,\r\n//         right: null,\r\n//         left: null,\r\n//         bottom: null,\r\n//       }\r\n//     }\r\n//\r\n//     return selection.getRangeAt(0).getBoundingClientRect()\r\n//   }\r\n//\r\n//   if (window.document.selection) {\r\n//     return window.document.selection\r\n//       .createRange()\r\n//       .getBoundingClientRect()\r\n//   }\r\n//\r\n//   return {\r\n//     top: null,\r\n//     right: null,\r\n//     left: null,\r\n//     bottom: null,\r\n//   }\r\n// }\r\n\r\n// if editor state is empty, remove cell when backspace or delete was pressed.\r\nexport const handleRemoveHotKey = (\r\n  _: KeyboardEvent,\r\n  {\r\n    content: {\r\n      state: { editorState }\r\n    }\r\n  }: Props\r\n) =>\r\n  new Promise(\r\n    (resolve: Function, reject: Function) =>\r\n      Plain.serialize(editorState).length < 1 ? resolve() : reject()\r\n  )\r\n\r\nconst windowSelectionWaitTime = 1\r\n\r\nexport const handleFocusPreviousHotKey = (\r\n  e: KeyboardEvent,\r\n  {\r\n    content: {\r\n      state: { editorState }\r\n    }\r\n  }: Props\r\n) => {\r\n  // const isArrowUp = e.keyCode === 38\r\n\r\n  return new Promise((resolve: Function, reject: Function) => {\r\n    if (editorState.selection.isExpanded) {\r\n      return reject()\r\n    }\r\n\r\n    setTimeout(() => {\r\n      // if (isArrowUp && next.top === current.top) {\r\n      //   return resolve()\r\n      // } else\r\n      if (\r\n        editorState.selection.isAtStartOf(editorState.document.nodes.first())\r\n      ) {\r\n        return resolve()\r\n      }\r\n      reject()\r\n    }, windowSelectionWaitTime)\r\n  })\r\n}\r\n\r\nexport const handleFocusNextHotKey = (\r\n  e: KeyboardEvent,\r\n  {\r\n    content: {\r\n      state: { editorState }\r\n    }\r\n  }: Props\r\n) => {\r\n  // const isArrowDown = e.keyCode === 40\r\n\r\n  return new Promise((resolve: Function, reject: Function) => {\r\n    if (editorState.selection.isExpanded) {\r\n      return reject()\r\n    }\r\n\r\n    setTimeout(() => {\r\n      // if (isArrowDown && next.top === current.top) {\r\n      //   return resolve()\r\n      // } else\r\n      if (editorState.selection.isAtEndOf(editorState.document.nodes.last())) {\r\n        return resolve()\r\n      }\r\n      reject()\r\n    }, windowSelectionWaitTime)\r\n  })\r\n}\r\n"]}